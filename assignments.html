<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Giao nhiệm vụ | Quiz Studio</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
        /* =========================================
           1. BỘ BIẾN MÀU (ĐỒNG BỘ TỪ DASHBOARD)
        ========================================= */
        :root {
            --primary: #2563eb;       /* Xanh dương đậm */
            --secondary: #60a5fa;     /* Xanh dương nhạt */
            --accent: #ff6b6b;
            --success: #00b09b;       /* Xanh ngọc mượt */
            --danger: #ff5f6d;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-dark: #2d3436;
        }

        /* =========================================
           2. CẤU HÌNH CƠ BẢN & ANIMATION CHUNG
        ========================================= */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Be Vietnam Pro', sans-serif; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            min-height: 100vh;
            background: url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1600&q=80') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px;
        }

        body::before {
            content: ''; position: fixed; inset: 0;
            background: rgba(0, 15, 40, 0.4);
            backdrop-filter: blur(8px); 
            z-index: -1;
        }

        /* Hiệu ứng bay lên */
        @keyframes dashboardSlideUp {
            0% { opacity: 0; transform: translateY(40px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .container { width: 100%; max-width: 1000px; z-index: 1; }

        /* =========================================
           3. GIAO DIỆN KÍNH MỜ (HEADER & CARD)
        ========================================= */
        header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass-bg); padding: 25px 30px; border-radius: 30px;
            border: 1px solid var(--glass-border); margin-bottom: 25px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: dashboardSlideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 30px; padding: 35px; margin-bottom: 25px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: dashboardSlideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            animation-delay: 0.1s; opacity: 0;
        }

        /* Hover khối kính */
        header:hover, .card:hover, .preview-card:hover {
            transform: translateY(-5px) scale(1.01); 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); 
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(255, 255, 255, 0.8);
        }

        /* =========================================
           4. FORM & INPUT
        ========================================= */
        input, textarea {
            width: 100%; padding: 14px; border-radius: 15px;
            border: 2px solid transparent; 
            background: rgba(255,255,255,0.7); 
            color: var(--text-dark); font-size: 15px; outline: none; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }

        input:focus, textarea:focus { 
            background: #ffffff !important; 
            transform: translateY(-2px);
            border-color: var(--secondary);
            /* Focus ring màu đồng bộ */
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2), 0 5px 20px rgba(37, 99, 235, 0.1);
        }

        .input-group { 
            display: flex; gap: 15px; align-items: flex-start; 
            margin-top: 15px; width: 100%;
        }

        .input-group input, .input-group textarea {
            flex: 1; width: auto; 
        }

        /* =========================================
           5. HỆ THỐNG NÚT BẤM (BUTTONS)
        ========================================= */
        button {
            padding: 12px 22px; border-radius: 15px; border: none; cursor: pointer;
            font-weight: 700; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px;
            color: white; background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.2);
            position: relative; overflow: hidden; font-size: 1rem;
        }

        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px rgba(37, 99, 235, 0.4); 
        }

        button:active { transform: translateY(-1px) scale(0.98); }

        /* Nút phụ (Trắng) */
        header button[onclick*="main.html"]:hover,
        #btnToggleManual:hover, 
        #btnToggleManual + button:hover {
             box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1) !important;
             background: white !important;
             color: var(--primary) !important;
        }

        /* Nút cộng (+) */
        .btn-plus {
            width: 48px; height: 48px; border-radius: 15px; background: #f8fafc;
            color: var(--primary); border: 2px solid transparent; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 1.2rem;
            transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-plus:hover { 
            transform: rotate(90deg) scale(1.1); 
            background: var(--primary); color: white; 
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4); 
        }
        .btn-plus:active { transform: rotate(90deg) scale(0.9); }

        /* Nút sửa nhỏ ở Preview */
        .btn-edit-preview {
            background: var(--primary); color: white; font-size: 12px;
            padding: 8px 16px; border-radius: 10px; margin-right: 8px; 
            display: inline-flex; align-items: center; gap: 5px; font-weight: 600;
        }
        .btn-edit-preview:hover {
            background: var(--secondary); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
        }

        /* =========================================
           6. TRẮC NGHIỆM (LỰA CHỌN A B C D)
        ========================================= */
        .choice-item { display: flex; align-items: center; gap: 15px; margin-top: 15px; }
        
        .choice-circle {
            width: 42px; height: 42px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            font-weight: 700; background: #fff; color: #64748b; flex-shrink: 0;
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); font-size: 1.1rem;
        }

        /* Hover khi chưa chọn */
        .choice-item:not(.correct) .choice-circle:hover {
            transform: scale(1.15); border-color: var(--primary); color: var(--primary);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.2);
        }

        /* Animation khi Click Chọn đúng */
        @keyframes pulseSuccess {
            0% { box-shadow: 0 0 0 0 rgba(0, 176, 155, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(0, 176, 155, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 176, 155, 0); }
        }

        .choice-item.correct .choice-circle { 
            background: var(--success); border-color: var(--success); color: white; 
            transform: scale(1.05);
            animation: pulseSuccess 0.6s ease-out forwards;
        }

        /* =========================================
           7. PANEL XEM TRƯỚC (PREVIEW CARD)
        ========================================= */
        #previewList {
            animation: dashboardSlideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            animation-delay: 0.2s; opacity: 0;
        }

        .preview-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 30px; margin-bottom: 25px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border-left: 6px solid transparent; /* Chuẩn bị cho hover */
        }

        .preview-card:hover {
            border-left-color: var(--secondary);
            transform: translateY(-5px) scale(1.01);
            background: rgba(255, 255, 255, 0.95);
        }

        .preview-q-text { font-size: 1.15rem; font-weight: 700; color: var(--text-dark); margin-bottom: 15px; }
        
        .preview-choice-item {
            background: rgba(255, 255, 255, 0.6); 
            padding: 12px 18px; border-radius: 12px; font-size: 1rem;
            margin-top: 10px; border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 10px; color: #475569; font-weight: 500;
        }
        
        .preview-choice-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .preview-choice-item.is-correct { 
            background: rgba(0, 176, 155, 0.1); /* Màu success của dashboard */
            border-color: rgba(0, 176, 155, 0.3); color: var(--success); font-weight: 700; 
        }

        .media-tag {
            font-size: 0.75rem; font-weight: 600; background: var(--secondary); color: white; 
            padding: 4px 12px; border-radius: 8px; margin-top: 8px; display: inline-block;
        }

        /* =========================================
           8. MODAL THÔNG BÁO
        ========================================= */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .my-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 9999;
            backdrop-filter: blur(8px);
        }

        .modal-box {
            background: white; padding: 40px; border-radius: 30px; 
            width: 90%; max-width: 450px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
    </style>
</head>
<body>

<div id="mediaModal" class="my-modal">
    <div class="modal-box">
        <h3 style="margin-bottom: 15px;">Chèn Hình ảnh / Video</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background:#f0f0f0; padding:20px; border-radius:15px; cursor:pointer;" onclick="openMediaInput('link')">
                <i class="fa-solid fa-link" style="font-size: 24px; color: var(--primary);"></i>
                <div style="margin-top:10px; font-weight:600">Dán Link</div>
            </div>
            <div style="background:#f0f0f0; padding:20px; border-radius:15px; cursor:pointer;" onclick="openMediaInput('file')">
                <i class="fa-solid fa-file-arrow-up" style="font-size: 24px; color: var(--primary);"></i>
                <div style="margin-top:10px; font-weight:600">Tải File</div>
            </div>
        </div>
        <button onclick="closeModal('mediaModal')" style="margin-top: 20px; width: 100%; justify-content: center; background: #ddd; color: #333;">Đóng</button>
    </div>
</div>

<div id="linkModal" class="my-modal">
    <div class="modal-box">
        <h3>Nhập URL Media</h3>
        <input type="text" id="inputUrlMedia" placeholder="https://..." style="margin: 20px 0;">
        <div style="display: flex; gap: 10px;">
            <button id="btnConfirmLink" style="flex: 1; justify-content: center;">OK</button>
            <button onclick="closeModal('linkModal')" style="background: #ddd; color: #333;">Hủy</button>
        </div>
    </div>
</div>

<div id="alertModal" class="my-modal">
    <div class="modal-box">
        <i id="alertIcon" class="fa-solid fa-circle-check" style="font-size: 40px; color: var(--success);"></i>
        <h3 id="alertTitle" style="margin-top: 15px;">Thông báo</h3>
        <p id="alertMsg" style="margin: 15px 0; color: #555;"></p>
        <button onclick="closeModal('alertModal')" style="width: 100%; justify-content: center;">Đã hiểu</button>
    </div>
</div>

<input type="file" id="hiddenFileInput" hidden accept="image/*,video/*">

<div class="container">
    <header>
        <div>
            <h1 style="color: var(--primary); font-weight: 700;">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Quiz Studio
            </h1>
            <p><i class="fa-solid fa-circle-user"></i> <span id="userEmail">Loading...</span></p>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="window.location.href='main.html'" 
                    style="background: white; color: var(--primary); border: 1px solid #ddd;">
                <i class="fa-solid fa-house"></i> Trang chủ
            </button>

            <button id="btnSaveKit">
                <i class="fa-solid fa-cloud-arrow-up"></i> Lưu bộ kit
            </button>
        </div>
    </header>

    <div class="card">
        <h3><i class="fa-solid fa-sliders"></i> Thiết lập bộ câu hỏi</h3>
        <input type="text" id="kitTitle" placeholder="Nhập tiêu đề bộ câu hỏi...">
        <div style="margin-top: 15px; display: flex; gap: 12px;">
            <button id="btnToggleManual" style="flex:1; background: #fff; color: #333; border: 1px solid #ddd; box-shadow: none;">
                <i class="fa-solid fa-pen-nib"></i> Soạn thủ công
            </button>
            <button style="flex:1; background: #fff; color: #333; border: 1px solid #ddd; box-shadow: none;">
                <i class="fa-solid fa-file-import"></i> Nhập từ file
            </button>
        </div>
    </div>

    <div class="card" id="manualArea" style="display: none; border-top: 5px solid var(--primary);">
        <h3 style="margin-bottom: 15px;">Soạn câu hỏi</h3>
        
        <div class="input-group">
            <textarea id="manualQName" rows="2" placeholder="Nhập câu hỏi..."></textarea>
            <button class="btn-plus" onclick="triggerMedia('question')"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="mediaTag_question"></div>

        <div id="manualChoices">
            <div class="choice-item">
                <div class="choice-circle" data-idx="0">A</div>
                <div class="input-group" style="width: 100%; margin:0;">
                    <input type="text" placeholder="Đáp án A">
                    <button class="btn-plus" onclick="triggerMedia('choice_0')"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <div id="mediaTag_choice_0"></div>

            <div class="choice-item">
                <div class="choice-circle" data-idx="1">B</div>
                <div class="input-group" style="width: 100%; margin:0;">
                    <input type="text" placeholder="Đáp án B">
                    <button class="btn-plus" onclick="triggerMedia('choice_1')"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <div id="mediaTag_choice_1"></div>

            <div class="choice-item">
                <div class="choice-circle" data-idx="2">C</div>
                <div class="input-group" style="width: 100%; margin:0;">
                    <input type="text" placeholder="Đáp án C">
                    <button class="btn-plus" onclick="triggerMedia('choice_2')"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <div id="mediaTag_choice_2"></div>

            <div class="choice-item">
                <div class="choice-circle" data-idx="3">D</div>
                <div class="input-group" style="width: 100%; margin:0;">
                    <input type="text" placeholder="Đáp án D">
                    <button class="btn-plus" onclick="triggerMedia('choice_3')"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <div id="mediaTag_choice_3"></div>
        </div>

        <button id="btnAddQuestion" style="width: 100%; margin-top: 25px; justify-content: center; padding: 15px;">
            <i class="fa-solid fa-plus-circle"></i> Thêm vào Preview
        </button>
    </div>

    <div id="previewList"></div>
</div>

<script>
    // --- CẤU HÌNH FIREBASE ---
    const firebaseConfig = { apiKey: "AIzaSyCd7vYlpSMcAlgwOPNBMyOhM0QIuzE-628", authDomain: "thaococo-70cc7.firebaseapp.com", projectId: "thaococo-70cc7" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // --- KHAI BÁO BIẾN ---
    let workingQuestions = [];
    let selectedIndices = [];
    let currentTarget = null;
    let tempMediaData = {};
    let editingIndex = -1; // -1: Thêm mới, >=0: Đang sửa câu hỏi số mấy

    // --- CÁC HÀM TIỆN ÍCH UI (POPUP, MODAL) ---
    function myAlert(msg, type = 'info') {
        const modal = document.getElementById('alertModal');
        const icon = document.getElementById('alertIcon');
        document.getElementById('alertMsg').innerText = msg;
        if(type === 'error') {
            icon.className = "fa-solid fa-circle-xmark"; icon.style.color = "var(--danger)";
        } else {
            icon.className = "fa-solid fa-circle-check"; icon.style.color = "var(--success)";
        }
        modal.style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function triggerMedia(target) { currentTarget = target; document.getElementById('mediaModal').style.display = 'flex'; }
    
    function openMediaInput(type) {
        closeModal('mediaModal');
        if(type === 'link') document.getElementById('linkModal').style.display = 'flex';
        else document.getElementById('hiddenFileInput').click();
    }

    // --- XỬ LÝ MEDIA (FILE & LINK) ---
    document.getElementById('hiddenFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (event) => saveMediaToTemp(event.target.result, 'file');
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('btnConfirmLink').addEventListener('click', () => {
        const url = document.getElementById('inputUrlMedia').value.trim();
        if(url) { saveMediaToTemp(url, 'link'); closeModal('linkModal'); document.getElementById('inputUrlMedia').value = ''; }
    });

    function saveMediaToTemp(data, type) {
        tempMediaData[currentTarget] = data;
        const tag = document.getElementById(`mediaTag_${currentTarget}`);
        tag.innerHTML = `<span class="media-tag"><i class="fa-solid fa-paperclip"></i> Đã đính kèm</span>`;
    }

    // --- XỬ LÝ CHỌN ĐÁP ÁN ĐÚNG ---
    document.querySelectorAll('.choice-circle').forEach(circle => {
        circle.addEventListener('click', () => {
            const idx = parseInt(circle.dataset.idx);
            if(selectedIndices.includes(idx)) {
                selectedIndices = selectedIndices.filter(i => i !== idx);
                circle.parentElement.classList.remove('correct');
            } else {
                selectedIndices.push(idx);
                circle.parentElement.classList.add('correct');
            }
        });
    });

    // --- LOGIC THÊM / SỬA CÂU HỎI VÀO DANH SÁCH ---
    document.getElementById('btnAddQuestion').addEventListener('click', () => {
        const qName = document.getElementById('manualQName').value.trim();
        const inputs = document.querySelectorAll('#manualChoices input');
        const choices = Array.from(inputs).map(i => i.value.trim());

        // Validate
        if(!qName || choices.some(c => !c) || selectedIndices.length === 0) {
            myAlert("Vui lòng nhập đủ thông tin và chọn đáp án đúng!", "error");
            return;
        }

        // Tạo object câu hỏi
        const questionObj = {
            question: qName,
            qMedia: tempMediaData['question'] || null,
            choices: choices.map((c, i) => ({ 
                text: c, 
                media: tempMediaData[`choice_${i}`] || null 
            })),
            correctIndices: [...selectedIndices]
        };

        if (editingIndex > -1) {
            // TRƯỜNG HỢP SỬA: Ghi đè
            workingQuestions[editingIndex] = questionObj;
            myAlert("Đã cập nhật câu hỏi!");
        } else {
            // TRƯỜNG HỢP THÊM MỚI: Push vào cuối
            workingQuestions.push(questionObj);
        }

        resetForm(); 
        renderPreview();
    });

    function resetForm() {
        document.getElementById('manualQName').value = '';
        document.querySelectorAll('#manualChoices input').forEach(i => i.value = '');
        document.querySelectorAll('.choice-item').forEach(item => item.classList.remove('correct'));
        document.querySelectorAll('[id^="mediaTag_"]').forEach(t => t.innerHTML = '');
        selectedIndices = []; 
        tempMediaData = {};
        
        // Reset trạng thái nút về "Thêm mới"
        editingIndex = -1;
        const btn = document.getElementById('btnAddQuestion');
        btn.innerHTML = '<i class="fa-solid fa-plus-circle"></i> Thêm vào Preview';
        btn.style.background = ""; // Trả về màu mặc định
    }

    // --- RENDER DANH SÁCH REVIEW ---
    function renderPreview() {
        const container = document.getElementById('previewList');
        container.innerHTML = workingQuestions.length > 0 
            ? `<h3 style="color:white; margin:20px 0; font-weight:600;">Danh sách xem trước (${workingQuestions.length})</h3>` 
            : '';

        workingQuestions.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = 'preview-card';
            if(i === editingIndex) div.style.border = "2px solid var(--primary)";

            // 1. Xử lý hiển thị ảnh cho Từng Đáp Án
            const choicesHtml = q.choices.map((c, idx) => `
                <div class="preview-choice-item ${q.correctIndices.includes(idx) ? 'is-correct' : ''}">
                    <div>
                        <strong>${String.fromCharCode(65 + idx)}.</strong> ${c.text}
                        ${c.media ? `<img src="${c.media}" style="display: block; margin-top: 5px; max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid #ccc;">` : ''}
                    </div>
                </div>
            `).join('');

            // 2. Xử lý hiển thị ảnh cho Câu Hỏi
            const qImageHtml = q.qMedia 
                ? `<div style="margin-top: 10px; text-align: center;">
                     <img src="${q.qMedia}" style="max-width: 100%; max-height: 250px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                   </div>` 
                : '';

            div.innerHTML = `
                <div class="preview-q-text">
                    Câu ${i + 1}: ${q.question}
                    ${qImageHtml} 
                </div>
                
                <div class="preview-choices">${choicesHtml}</div>
                
                <div style="margin-top: 15px; text-align: right;">
                    <button onclick="editQuestion(${i})" class="btn-edit-preview">
                        <i class="fa-solid fa-pen"></i> Sửa
                    </button>
                    
                    <button onclick="removeQuestion(${i})" style="background: var(--danger); font-size: 12px; padding: 6px 15px; border-radius: 8px; color:white; display: inline-flex; align-items: center; gap: 5px;">
                        <i class="fa-solid fa-trash-can"></i> Xóa
                    </button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function removeQuestion(idx) {
        workingQuestions.splice(idx, 1);
        renderPreview();
    }

    // --- LOGIC ĐẨY DỮ LIỆU LÊN EDIT FORM ---
    function editQuestion(idx) {
        const q = workingQuestions[idx];
        editingIndex = idx; 

        // 1. Điền text
        document.getElementById('manualQName').value = q.question;
        const inputs = document.querySelectorAll('#manualChoices input');
        q.choices.forEach((c, i) => {
            if(inputs[i]) inputs[i].value = c.text;
        });

        // 2. Điền đáp án đúng
        selectedIndices = [...q.correctIndices];
        document.querySelectorAll('.choice-circle').forEach(circle => {
            const cIdx = parseInt(circle.dataset.idx);
            if (selectedIndices.includes(cIdx)) circle.parentElement.classList.add('correct');
            else circle.parentElement.classList.remove('correct');
        });

        // 3. Khôi phục Media
        tempMediaData = {}; 
        
        if(q.qMedia) {
            tempMediaData['question'] = q.qMedia;
            document.getElementById('mediaTag_question').innerHTML = `<span class="media-tag"><i class="fa-solid fa-check"></i> Đang có media cũ</span>`;
        } else {
            document.getElementById('mediaTag_question').innerHTML = '';
        }

        q.choices.forEach((c, i) => {
            const tag = document.getElementById(`mediaTag_choice_${i}`);
            if(c.media) {
                tempMediaData[`choice_${i}`] = c.media;
                tag.innerHTML = `<span class="media-tag"><i class="fa-solid fa-check"></i> Đang có media cũ</span>`;
            } else {
                tag.innerHTML = '';
            }
        });

        // 4. Đổi giao diện nút bấm
        const btn = document.getElementById('btnAddQuestion');
        btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Lưu sửa đổi';
        btn.style.background = "linear-gradient(135deg, #ff9966, #ff5e62)"; 
        
        document.getElementById('manualArea').style.display = 'block';
        document.getElementById('manualArea').scrollIntoView({ behavior: 'smooth' });
        renderPreview(); 
    }

    // --- LOGIC LƯU BỘ KIT (TẠO MỚI HOẶC CẬP NHẬT) ---
    document.getElementById('btnSaveKit').addEventListener('click', async () => {
        // 1. KIỂM TRA ĐĂNG NHẬP
        const user = auth.currentUser;
        if (!user) {
            return myAlert("Vui lòng đăng nhập để lưu bài!", "error");
        }

        // 2. Lấy dữ liệu
        const title = document.getElementById('kitTitle').value.trim();
        if(!title || workingQuestions.length === 0) {
            return myAlert("Thiếu tên bộ hoặc chưa có câu hỏi nào!", "error");
        }
        
        // Kiểm tra chế độ Edit
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');

        // Hiệu ứng nút bấm đang lưu
        const btn = document.getElementById('btnSaveKit');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
        btn.disabled = true;

        // ==========================================
        // CÁCH LÁCH LUẬT FIREBASE: CHUYỂN MẢNG THÀNH OBJECT
        const safeQuestionsArray = JSON.parse(JSON.stringify(workingQuestions));
        const questionsMap = {};
        
        safeQuestionsArray.forEach((q, index) => {
            // Dùng q_000, q_001 để đảm bảo thứ tự câu hỏi không bị xáo trộn
            const key = `q_${index.toString().padStart(3, '0')}`;
            questionsMap[key] = q; 
        });
        // ==========================================

        try {
            if (editId) {
                // --- UPDATE BỘ CŨ ---
                await db.collection('kits').doc(editId).update({
                    title: title,
                    questions: questionsMap, // Đẩy Object lên thay vì Mảng
                    updatedAt: new Date().toISOString(),
                    ownerId: user.uid 
                });
                
                myAlert("Cập nhật bộ câu hỏi thành công!");
                setTimeout(() => { window.location.href = "main.html"; }, 1500);

            } else {
                // --- TẠO BỘ MỚI ---
                await db.collection('kits').add({
                    ownerId: user.uid, 
                    ownerEmail: user.email, 
                    title: title,
                    questions: questionsMap, // Đẩy Object lên thay vì Mảng
                    createdAt: new Date().toISOString()
                });

                myAlert("Đã tạo bộ câu hỏi mới thành công!");
                setTimeout(() => { window.location.href = "main.html"; }, 1500);
            }
        } catch(e) { 
            console.error(e);
            myAlert("Lỗi lưu trữ: " + e.message, "error"); 
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    });

    // --- AUTH & KHỞI TẠO ---
    auth.onAuthStateChanged(user => {
        if(!user) window.location.href = 'login.html';
        else {
            if(document.getElementById('userEmail')) {
                document.getElementById('userEmail').innerText = user.email;
            }
        }
    });

    document.getElementById('btnToggleManual').addEventListener('click', () => {
        const area = document.getElementById('manualArea');
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
    });

    // --- KIỂM TRA CHẾ ĐỘ SỬA (KHI LOAD TRANG) ---
    const urlParamsNew = new URLSearchParams(window.location.search);
    const editKitId = urlParamsNew.get('edit');

    if (editKitId) {
        loadKitToEdit(editKitId);
    }

    async function loadKitToEdit(id) {
        try {
            const doc = await db.collection('kits').doc(id).get();
            if (!doc.exists) {
                myAlert("Bộ câu hỏi không tồn tại hoặc đã bị xóa!", "error");
                return;
            }

            const data = doc.data();
            
            // 1. Điền thông tin
            document.getElementById('kitTitle').value = data.title;

            // ==========================================
            // XỬ LÝ DỮ LIỆU KHI TẢI VỀ (Từ Object trả lại Mảng)
            const rawQuestions = data.questions || {};
            if (Array.isArray(rawQuestions)) {
                workingQuestions = rawQuestions; // Đề phòng bộ kit cũ lưu dạng mảng
            } else {
                // Sắp xếp lại đúng thứ tự q_000, q_001... và chuyển về dạng Mảng
                workingQuestions = Object.keys(rawQuestions).sort().map(k => rawQuestions[k]);
            }
            // ==========================================
            
            // 2. Render
            renderPreview();
            
            // 3. Đổi nút Lưu thành Cập nhật
            const btnSave = document.getElementById('btnSaveKit');
            btnSave.innerHTML = '<i class="fa-solid fa-rotate"></i> Cập nhật bộ Kit';

            // 4. Thông báo
            myAlert("Đã tải dữ liệu bộ: " + data.title);

        } catch (e) {
            console.error(e);
            myAlert("Lỗi tải dữ liệu: " + e.message, "error");
        }
    }
</script>
</body>
</html>
